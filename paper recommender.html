<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paper Recommender</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple spinner for loading state */
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 32px;
            height: 32px;
            -webkit-animation: spin 2s linear infinite; /* Safari */
            animation: spin 2s linear infinite;
        }

        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl">
        <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
            <h1 class="text-3xl sm:text-4xl font-bold mb-2 text-center text-gray-900">Paper Recommender</h1>
            <p class="text-center text-gray-500 mb-6">Enter a paper's DOI, then click a tab to find related articles.</p>

            <!-- Input form -->
            <div class="mb-6">
                <label for="doiInput" class="sr-only">DOI Input</label>
                <input type="text" id="doiInput" placeholder="e.g., 10.1109/ACCESS.2023.3239784" class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow">
            </div>
            
            <!-- Controls: Tabs and Sorting -->
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 border-b border-gray-200">
                <!-- Tab Navigation -->
                <nav id="tab-nav" class="flex -mb-px space-x-6" aria-label="Tabs">
                    <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-type="recommendations">
                        Recommendations
                    </button>
                    <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-type="citations">
                        Citing Papers
                    </button>
                    <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-type="references">
                        Cited Papers
                    </button>
                </nav>
                 <!-- Sort Dropdown -->
                <div class="mt-4 sm:mt-0">
                    <label for="sortSelect" class="sr-only">Sort by</label>
                    <select id="sortSelect" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        <option value="citationCount" selected>Sort by Citations</option>
                        <option value="year">Sort by Year</option>
                    </select>
                </div>
            </div>

            <!-- Loading Spinner and Message Area -->
            <div id="statusArea" class="text-center my-4"></div>

            <!-- Results Section -->
            <div id="results" class="space-y-4">
                <!-- Papers will be injected here -->
            </div>
        </div>
        <footer class="text-center mt-6 text-gray-500 text-sm">
            <p>Powered by <a href="https://www.semanticscholar.org/product/api" target="_blank" class="text-blue-600 hover:underline">Semantic Scholar API</a></p>
        </footer>
    </div>

    <script>
        // DOM element references
        const doiInput = document.getElementById('doiInput');
        const tabContainer = document.getElementById('tab-nav');
        const sortSelect = document.getElementById('sortSelect');
        const resultsContainer = document.getElementById('results');
        const statusArea = document.getElementById('statusArea');

        // Cache for the last set of fetched papers
        let currentPapers = [];

        // Event listener for tab clicks using event delegation
        tabContainer.addEventListener('click', (event) => {
            const clickedButton = event.target.closest('.tab-button');
            if (!clickedButton) return;

            const searchType = clickedButton.dataset.type;

            // Update tab styles
            const allTabs = tabContainer.querySelectorAll('.tab-button');
            allTabs.forEach(tab => {
                tab.classList.remove('border-blue-500', 'text-blue-600');
                tab.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            });

            clickedButton.classList.add('border-blue-500', 'text-blue-600');
            clickedButton.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            
            initiateSearch(searchType);
        });

        // Event listener for the sort dropdown
        sortSelect.addEventListener('change', () => {
            // Re-sort and display the currently cached papers
            displayResults(currentPapers);
        });

        /**
         * Initiates a search for a given type (recommendations, citations, etc.).
         * @param {string} searchType - The type of search to perform.
         */
        async function initiateSearch(searchType) {
            const doi = doiInput.value.trim();

            if (!doi) {
                displayMessage('Please enter a DOI before selecting a tab.', 'error');
                return;
            }

            resultsContainer.innerHTML = '';
            showLoading(true);
            displayMessage('', 'info');

            try {
                let papers;
                if (searchType === 'recommendations') {
                    papers = await fetchRecommendations(doi);
                } else {
                    papers = await fetchGraphPapers(doi, searchType);
                }
                
                // Filter and cache the results
                currentPapers = filterPapers(papers);
                displayResults(currentPapers);

            } catch (error) {
                console.error("Failed to fetch papers:", error);
                displayMessage('Failed to fetch papers. Please check the DOI or try again later.', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        /**
         * Fetches paper recommendations from the API.
         * @param {string} doi - The DOI of the seed paper.
         * @returns {Promise<Array>} A promise resolving to an array of recommended papers.
         */
        async function fetchRecommendations(doi) {
            const apiUrl = 'https://api.semanticscholar.org/recommendations/v1/papers';
            const params = { fields: 'title,citationCount,url,venue,publicationTypes,authors,year' };
            const body = { "positivePaperIds": [doi] };

            const url = new URL(apiUrl);
            Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
            
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            if (!response.ok) throw new Error(`API error: ${response.status} ${response.statusText}`);

            const data = await response.json();
            return data.recommendedPapers || [];
        }

        /**
         * Fetches citing or cited papers from the graph API.
         * @param {string} doi - The DOI of the seed paper.
         * @param {string} type - 'citations' or 'references'.
         * @returns {Promise<Array>} A promise resolving to an array of related papers.
         */
        async function fetchGraphPapers(doi, type) {
            let allPapers = [];
            let offset = 0;
            const limit = 100;

            while (true) {
                const params = new URLSearchParams({
                    fields: 'title,citationCount,url,venue,publicationTypes,authors,year',
                    offset: offset,
                    limit: limit
                });
                
                const url = `https://api.semanticscholar.org/graph/v1/paper/${doi}/${type}?${params.toString()}`;
                const response = await fetch(url);

                if (!response.ok) throw new Error(`API error: ${response.status} ${response.statusText}`);
                
                const results = await response.json();
                const data = results.data || [];
                
                const papers = data.map(item => type === 'citations' ? item.citingPaper : item.citedPaper);
                allPapers.push(...papers);
                
                if (results.next) {
                    offset = results.next;
                } else {
                    break;
                }
            }
            return allPapers;
        }

        /**
         * Filters an array of papers based on predefined criteria.
         * @param {Array} papers - The array of paper objects.
         * @returns {Array} The filtered array of papers.
         */
        function filterPapers(papers = []) {
            if (!papers) return [];
            
            return papers.filter(paper => 
                paper &&
                paper.publicationTypes &&
                paper.publicationTypes.includes('JournalArticle') &&
                paper.citationCount > 0
            );
        }

        /**
         * Sorts and renders the papers on the page.
         * @param {Array} papers - The array of filtered paper objects to display.
         */
        function displayResults(papers) {
            resultsContainer.innerHTML = ''; 

            if (!papers || papers.length === 0) {
                displayMessage('No relevant journal articles with citations found.', 'info');
                return;
            }

            const sortBy = sortSelect.value;
            // Create a mutable copy for sorting
            const sortedPapers = [...papers];

            // Sort papers based on the selected option
            sortedPapers.sort((a, b) => {
                const valA = a[sortBy] || 0;
                const valB = b[sortBy] || 0;
                return valB - valA; // Descending order
            });

            // Create a card for each paper
            sortedPapers.forEach(paper => {
                const authors = paper.authors && paper.authors.length > 0 ? paper.authors.map(a => a.name).join(', ') : 'N/A';

                const paperElement = document.createElement('div');
                paperElement.className = 'bg-gray-50 border border-gray-200 p-5 rounded-lg shadow-sm hover:shadow-md transition-shadow';
                paperElement.innerHTML = `
                    <h3 class="font-bold text-lg text-blue-800 mb-1">${paper.title || 'Title not available'}</h3>
                    <p class="text-sm text-gray-600 mb-2"><strong>Authors:</strong> ${authors}</p>
                    <div class="flex flex-wrap items-center gap-x-4 gap-y-1 text-sm text-gray-500">
                        <span><strong>Venue:</strong> ${paper.venue || 'N/A'}</span>
                        <span><strong>Year:</strong> ${paper.year || 'N/A'}</span>
                        <span class="font-semibold"><strong>Citations:</strong> ${paper.citationCount}</span>
                    </div>
                    <a href="${paper.url}" target="_blank" rel="noopener noreferrer" class="inline-block mt-3 text-blue-600 font-semibold hover:underline">
                        Read Paper &rarr;
                    </a>
                `;
                resultsContainer.appendChild(paperElement);
            });
        }
        
        /**
         * Displays a status message to the user.
         * @param {string} message - The message to display.
         * @param {'info'|'error'} type - The type of message.
         */
        function displayMessage(message, type = 'info') {
             statusArea.innerHTML = '';
             if (!message) return;
             
             const messageElement = document.createElement('p');
             const colorClass = type === 'error' ? 'text-red-600' : 'text-gray-600';
             messageElement.className = `${colorClass} font-medium`;
             messageElement.textContent = message;
             statusArea.appendChild(messageElement);
        }

        /**
         * Shows or hides the loading spinner.
         * @param {boolean} isLoading - Whether to show the spinner.
         */
        function showLoading(isLoading) {
            if (isLoading) {
                const spinner = document.createElement('div');
                spinner.className = 'loader mx-auto';
                statusArea.innerHTML = '';
                statusArea.appendChild(spinner);
            } else {
                const spinner = statusArea.querySelector('.loader');
                if (spinner) spinner.remove();
            }
        }
    </script>

</body>
</html>
